name: Notify GenAI team on "Ready for review" PRs

on:
  pull_request:
    types: [labeled]
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Send notification to Slack
        if: github.event_name == 'pull_request'
        run: |
          LABEL_NAME="${{ github.event.label.name }}"
          # Check if label contains 'ready for review' (case-insensitive)
          if ! echo "$LABEL_NAME" | grep -i 'ready for review' >/dev/null; then
            echo "Label does not contain 'ready for review' (case-insensitive), skipping notification."
            exit 0
          fi
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          PR_NR="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_ADDITIONS="${{ github.event.pull_request.additions }}"
          PR_DELETIONS="${{ github.event.pull_request.deletions }}"
          REPO_NAME="${{ github.event.repository.name }}"

          # Escape special characters for JSON
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g; s/"/\\"/g')
          PR_AUTHOR_ESCAPED=$(echo "$PR_AUTHOR" | sed 's/\\/\\\\/g; s/"/\\"/g')
          REPO_NAME_ESCAPED=$(echo "$REPO_NAME" | sed 's/\\/\\\\/g; s/"/\\"/g')

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Pull Request Ready for Review!*\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"@buzok-team: :rocket: PR by ${PR_AUTHOR_ESCAPED} needs a review:\\n<${PR_URL}|${REPO_NAME_ESCAPED}#${PR_NR}: ${PR_TITLE_ESCAPED}> \`+${PR_ADDITIONS} -${PR_DELETIONS}\`\"
                }
              }
            ]
          }" \
          "${SLACK_WEBHOOK_URL}"
      - name: Send summary notification to Slack
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          REPO_NAME="${{ github.repository }}"

          # Get PRs with any label containing "ready for review" (case-insensitive)
          PRS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${REPO_NAME}/pulls?state=open&per_page=100")
          echo "All open PRs (before filtering):"
          echo "$PRS_JSON" | jq -r '.[] | "Title: " + .title + " | Labels: " + ([.labels[].name] | join(", "))'
          # Filter PRS_JSON to only PRs with a label containing 'ready for review' (case-insensitive)
          PRS_JSON=$(echo "$PRS_JSON" | jq '[.[] | select(.labels[]?.name | ascii_downcase | test("ready for review"))]')
          echo "Open PRs after filtering for 'ready for review' label (case-insensitive):"
          echo "$PRS_JSON" | jq -r '.[] | "Title: " + .title + " | Labels: " + ([.labels[].name] | join(", "))'

          # Filter PRs with "Ready for Review" label and format them (fetching details for correct additions/deletions)
          PR_LIST=""
          for PR_NUMBER in $(echo "$PRS_JSON" | jq -r '.[].number'); do
            PR_DETAIL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${REPO_NAME}/pulls/${PR_NUMBER}")
            TITLE=$(echo "$PR_DETAIL" | jq -r '.title')
            USER=$(echo "$PR_DETAIL" | jq -r '.user.login')
            ADDITIONS=$(echo "$PR_DETAIL" | jq -r '.additions')
            DELETIONS=$(echo "$PR_DETAIL" | jq -r '.deletions')
            HTML_URL=$(echo "$PR_DETAIL" | jq -r '.html_url')
            LINE="â€¢ PR <$HTML_URL|#$PR_NUMBER: $TITLE> by $USER needs a review: \`+$ADDITIONS -$DELETIONS\`"
            echo "Found PR marked as ready for review: $LINE"
            # Escape special characters for JSON
            ESCAPED_LINE=$(echo "$LINE" | sed 's/\\/\\\\/g; s/"/\\"/g')
            if [ -z "$PR_LIST" ]; then
              PR_LIST="$ESCAPED_LINE"
            else
              PR_LIST="$PR_LIST\\n$ESCAPED_LINE"
            fi
          done


          # Only send notification if there are PRs ready for review
          if [ -n "$PR_LIST" ]; then
              echo "PR_LIST content before sending notification:"
              echo -e "$PR_LIST"
            curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"*Pull Requests Ready for Review Summary*\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \":clipboard: Here are the open PRs ready for review:\\n$PR_LIST\"
                  }
                }
              ]
            }" \
            "${SLACK_WEBHOOK_URL}"
            else
              echo "No PRs found with a 'ready for review' label. PR_LIST is empty."
          fi
