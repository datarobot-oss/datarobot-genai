name: Notify GenAI team on "Ready for review" PRs

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Check if label is ready for review
        if: github.event_name == 'pull_request'
        id: check-label
        run: |
          LABEL_NAME="${{ github.event.label.name }}"
          # Check if label contains 'ready for review' (case-insensitive)
          if ! echo "$LABEL_NAME" | grep -i 'ready for review' >/dev/null; then
            echo "Label does not contain 'ready for review' (case-insensitive), skipping notification."
            echo "should-continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "should-continue=true" >> $GITHUB_OUTPUT
          
      - name: Add team-specific labels based on reviewers
        if: false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NR="${{ github.event.pull_request.number }}"
          
          # Check if Buzok team is a code reviewer and add label if needed
          PR_REVIEWERS=$(gh pr view "$PR_NR" --json reviewRequests --jq '.reviewRequests[].name, .reviewRequests[].slug')
          echo "PR Reviewers: $PR_REVIEWERS"
          
          if echo "$PR_REVIEWERS" | grep -E "(datarobot-community/buzok|Buzok)" >/dev/null; then
            echo "Buzok team is a reviewer, adding label..."
            gh pr edit "$PR_NR" --add-label "Needs Review: GenAI Tooling (Buzok)"
          fi
          
          if echo "$PR_REVIEWERS" | grep -E "(datarobot-community/docs|Docs)" >/dev/null; then
            echo "Docs team is a reviewer, adding label..."
            gh pr edit "$PR_NR" --add-label "Needs Review: Docs"
          fi
          
      - name: Send notification to Slack
        if: github.event_name == 'pull_request' && steps.check-label.outputs.should-continue == 'true'
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          PR_NR="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_ADDITIONS="${{ github.event.pull_request.additions }}"
          PR_DELETIONS="${{ github.event.pull_request.deletions }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          # Escape special characters for JSON
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g; s/"/\\"/g')
          PR_AUTHOR_ESCAPED=$(echo "$PR_AUTHOR" | sed 's/\\/\\\\/g; s/"/\\"/g')
          REPO_NAME_ESCAPED=$(echo "$REPO_NAME" | sed 's/\\/\\\\/g; s/"/\\"/g')

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Pull Request Ready for Review!*\", 
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"@buzok-team: :rocket: PR by ${PR_AUTHOR_ESCAPED} needs a review:\\n<${PR_URL}|${REPO_NAME_ESCAPED}#${PR_NR}: ${PR_TITLE_ESCAPED}> \`+${PR_ADDITIONS} -${PR_DELETIONS}\`\"
                }
              }
            ]
          }" \
          "${SLACK_WEBHOOK_URL}"
