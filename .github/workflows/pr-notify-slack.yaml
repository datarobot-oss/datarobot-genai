name: Notify GenAI team on "Ready for review" PRs

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch open PRs with ready for review labels
        id: fetch-prs
        run: |
          REPO_NAME="${{ github.repository }}"
          
          # Get PRs with any label containing "ready for review" (case-insensitive)
          PRS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${REPO_NAME}/pulls?state=open&per_page=100")
          echo "All open PRs (before filtering):"
          echo "$PRS_JSON" | jq -r '.[] | "Title: " + .title + " | Labels: " + ([.labels[].name] | join(", "))'
          
          # Filter PRS_JSON to only PRs with a label containing 'ready for review' (case-insensitive) and exclude those with "00 - Reviewed" label
          PRS_JSON=$(echo "$PRS_JSON" | jq '[.[] | select(
            (.labels[]?.name | ascii_downcase | test("ready for review")) and
            (.labels | map(.name) | any(. == "00 - Reviewed") | not)
          )]')
          echo "Open PRs after filtering for 'ready for review' label (excluding '00 - Reviewed'):"
          echo "$PRS_JSON" | jq -r '.[] | "Title: " + .title + " | Labels: " + ([.labels[].name] | join(", "))'
          
          # Save PR numbers to output
          PR_NUMBERS=$(echo "$PRS_JSON" | jq -r '.[].number' | tr '\n' ' ')
          echo "pr-numbers=$PR_NUMBERS" >> $GITHUB_OUTPUT
          
      - name: Build PR list excluding approved PRs
        id: build-pr-list
        run: |
          REPO_NAME="${{ github.repository }}"
          PR_NUMBERS="${{ steps.fetch-prs.outputs.pr-numbers }}"
          
          # Filter PRs with "Ready for Review" label and format them (fetching details for correct additions/deletions)
          PR_LIST=""
          for PR_NUMBER in $PR_NUMBERS; do
            # Check if PR has any approved reviews
            REVIEWS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${REPO_NAME}/pulls/${PR_NUMBER}/reviews")
            HAS_APPROVAL=$(echo "$REVIEWS" | jq '[.[] | select(.state == "APPROVED")] | length > 0')

            if [ "$HAS_APPROVAL" = "true" ]; then
              echo "Skipping PR #$PR_NUMBER - already has an approval"
              continue
            fi

            PR_DETAIL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${REPO_NAME}/pulls/${PR_NUMBER}")
            TITLE=$(echo "$PR_DETAIL" | jq -r '.title')
            USER=$(echo "$PR_DETAIL" | jq -r '.user.login')
            ADDITIONS=$(echo "$PR_DETAIL" | jq -r '.additions')
            DELETIONS=$(echo "$PR_DETAIL" | jq -r '.deletions')
            HTML_URL=$(echo "$PR_DETAIL" | jq -r '.html_url')
            LINE="â€¢ PR <$HTML_URL|#$PR_NUMBER: $TITLE> by $USER needs a review: \`+$ADDITIONS -$DELETIONS\`"
            echo "Found PR marked as ready for review: $LINE"
            # Escape special characters for JSON and bash
            ESCAPED_LINE=$(echo "$LINE" | sed 's/\\/\\\\/g; s/"/\\"/g; s/`/\\`/g; s/\$/\\$/g; s/\t/\\t/g; s/\r/\\r/g')
            if [ -z "$PR_LIST" ]; then
              PR_LIST="$ESCAPED_LINE"
            else
              PR_LIST="$PR_LIST\\n$ESCAPED_LINE"
            fi
          done
          
          echo "pr-list<<EOF" >> $GITHUB_OUTPUT
          echo -e "$PR_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Send summary notification to Slack
        if: steps.build-pr-list.outputs.pr-list != ''
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          PR_LIST="${{ steps.build-pr-list.outputs.pr-list }}"
          
          echo "PR_LIST content before sending notification:"
          echo -e "$PR_LIST"
          
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Pull Requests Ready for Review Summary*\", 
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \":clipboard: Here are the open PRs ready for review:\\n$PR_LIST\"
                }
              }
            ]
          }" \
          "${SLACK_WEBHOOK_URL}"
