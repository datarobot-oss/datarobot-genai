name: Add Jira Link Comment

on:
  workflow_call:
    inputs:
      pr_title:
        required: true
        type: string
      pr_number:
        required: true
        type: number
      pr_branch:
        required: true
        type: string

jobs:
  add-jira-link:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Extract Jira Ticket ID from PR title
        id: extract-ticket
        run: |
          PR_TITLE="${{ inputs.pr_title }}"
          PR_BRANCH="${{ inputs.pr_branch }}"

          # Extract ticket ID from PR title: [BUZZOK-12345] or [PROJECT-123]
          TICKET_ID=$(echo "$PR_TITLE" | grep -oE '\[([A-Z]+-[0-9]+)\]' | tr -d '[]' || echo "")

          # Fallback: extract from branch name, e.g. user/BUZZOK-2342-something or BUZZOK-1234
          if [ -z "$TICKET_ID" ]; then
            TICKET_ID=$(echo "$PR_BRANCH" | grep -oE '[A-Z]+-[0-9]+' | head -1 || echo "")
          fi

          if [ -n "$TICKET_ID" ]; then
            echo "ticket-id=$TICKET_ID" >> $GITHUB_OUTPUT
            echo "has-ticket=true" >> $GITHUB_OUTPUT
            echo "Found Jira ticket: $TICKET_ID"
          else
            echo "has-ticket=false" >> $GITHUB_OUTPUT
            echo "No Jira ticket found in PR title or branch name"
          fi

      - name: Comment with Jira link
        if: steps.extract-ticket.outputs.has-ticket == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const ticketId = '${{ steps.extract-ticket.outputs.ticket-id }}';
            const jiraUrl = `https://datarobot.atlassian.net/browse/${ticketId}`;
            const commentBody = `### ðŸŽ« Jira Ticket\n\n[${ticketId}](${jiraUrl})`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr_number }},
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸŽ« Jira Ticket')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
              console.log('Updated existing Jira link comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.pr_number }},
                body: commentBody
              });
              console.log('Created new Jira link comment');
            }
