name: Notify GenAI team on "Ready for review" PRs

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      pr_url:
        required: true
        type: string
      pr_title:
        required: true
        type: string
      pr_author:
        required: true
        type: string
      pr_additions:
        required: true
        type: number
      pr_deletions:
        required: true
        type: number
      repo_name:
        required: true
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        required: true

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Add team-specific labels based on reviewers
        if: false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NR="${{ inputs.pr_number }}"

          # Check if Buzok team is a code reviewer and add label if needed
          PR_REVIEWERS=$(gh pr view "$PR_NR" --json reviewRequests --jq '.reviewRequests[].name, .reviewRequests[].slug')
          echo "PR Reviewers: $PR_REVIEWERS"

          if echo "$PR_REVIEWERS" | grep -E "(datarobot-community/buzok|Buzok)" >/dev/null; then
            echo "Buzok team is a reviewer, adding label..."
            gh pr edit "$PR_NR" --add-label "Needs Review: GenAI Tooling (Buzok)"
          fi

          if echo "$PR_REVIEWERS" | grep -E "(datarobot-community/docs|Docs)" >/dev/null; then
            echo "Docs team is a reviewer, adding label..."
            gh pr edit "$PR_NR" --add-label "Needs Review: Docs"
          fi

      - name: Send notification to Slack
        run: |
          SLACK_WEBHOOK_URL="${{ secrets.SLACK_WEBHOOK_URL }}"
          PR_NR="${{ inputs.pr_number }}"
          PR_URL="${{ inputs.pr_url }}"
          PR_TITLE="${{ inputs.pr_title }}"
          PR_AUTHOR="${{ inputs.pr_author }}"
          PR_ADDITIONS="${{ inputs.pr_additions }}"
          PR_DELETIONS="${{ inputs.pr_deletions }}"
          REPO_NAME="${{ inputs.repo_name }}"

          # Escape special characters for JSON
          PR_TITLE_ESCAPED=$(echo "$PR_TITLE" | sed 's/\\/\\\\/g; s/"/\\"/g')
          PR_AUTHOR_ESCAPED=$(echo "$PR_AUTHOR" | sed 's/\\/\\\\/g; s/"/\\"/g')
          REPO_NAME_ESCAPED=$(echo "$REPO_NAME" | sed 's/\\/\\\\/g; s/"/\\"/g')

          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"*Pull Request Ready for Review!*\",
            \"blocks\": [
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"@buzok-team: :rocket: PR by ${PR_AUTHOR_ESCAPED} needs a review:\\n<${PR_URL}|${REPO_NAME_ESCAPED}#${PR_NR}: ${PR_TITLE_ESCAPED}> \`+${PR_ADDITIONS} -${PR_DELETIONS}\`\"
                }
              }
            ]
          }" \
          "${SLACK_WEBHOOK_URL}"
