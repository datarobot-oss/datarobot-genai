# https://taskfile.dev

version: '3'

env:
  SESSION_SECRET_KEY: acceptance-test-secret

tasks:
  drmcp-install:
    desc: "ðŸ”§ Install drmcp and dev dependencies for development"
    cmds:
      - echo "ðŸ”§ Installing DR MCP Library and dev dependencies for development"
      - uv sync --extra drmcp --dev
    silent: true

  drmcp-dev:
    desc: "ðŸ”¨ Running DR MCP Library locally"
    cmds:
      - echo "ðŸ”¨ Starting DR MCP Library development server"
      - task: drmcp-install
      - uv run src/datarobot_genai/drmcp/server.py
    silent: true

  drmcp-ete-test-server:
    desc: "ðŸ”¨ Running DR MCP Library test server"
    cmds:
      - echo "ðŸ”¨ Starting DR MCP Library development server"
      - task: drmcp-install
      - uv run tests/drmcp/acceptance/ete_test_server.py
    silent: true

  drmcp-test-dev-server-background:
    desc: "ðŸ”¨ Running DR MCP Library locally in background"
    vars:
      PORT: 8652
    cmds:
      - echo "ðŸ”¨ Starting DR MCP Library development server"
      - echo "MCP Server running on port {{.PORT}}"
      - |
        if lsof -i :{{.PORT}} > /dev/null 2>&1; then
          echo "Killing existing process on port {{.PORT}}"
          lsof -i :{{.PORT}} | grep LISTEN | awk '{print $2}' | xargs kill -9 2>/dev/null || true
        fi
      - |
        OTEL_ATTRIBUTES='{"environment":"test","service.instance.id":"ete-tests"}' \
        OTEL_COLLECTOR_BASE_URL=http://localhost:4318 \
        OTEL_ENTITY_ID=deployment-68924b8b51102f055bef861c \
        MCP_SERVER_PORT={{.PORT}} task drmcp-ete-test-server &
      - |
        for i in {1..30}; do
          if curl -s http://localhost:{{.PORT}}/ > /dev/null 2>&1; then
            echo "Server is ready"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "Server failed to start"
            exit 1
          fi
          sleep 1
        done
    silent: false

  drmcp-test-otel-server-background:
    desc: "ðŸ”¨ Running DR MCP Library locally in background with OTEL"
    cmds:
      - echo "ðŸ”¨ Ensuring Jaeger (OTEL) is running"
      - |
        if ! command -v docker >/dev/null 2>&1 || ! docker info >/dev/null 2>&1; then
          echo "Docker isn't running, skipping OTEL startup"
          exit 0
        fi
        if docker ps -q --filter name=jaeger --filter status=running | grep -q .; then
          echo "Jaeger already running, using existing container"
          exit 0
        fi
        if docker ps -aq --filter name=jaeger | grep -q .; then
          echo "Starting existing Jaeger container"
          docker start jaeger >/dev/null 2>&1 || true
        else
          echo "Launching new Jaeger container"
          docker run -d --name jaeger -p 16686:16686 -p 4318:4318 -e COLLECTOR_OTLP_ENABLED=true jaegertracing/all-in-one:1.54 >/dev/null 2>&1 || true
        fi
    silent: false

  drmcp-test:
    silent: true
    desc: "ðŸ§ª Run DR MCP Library tests"
    cmds:
      - rm -rf .coverage .coverage.xml htmlcov
      - echo "ðŸ§ª Running all DR MCP Library tests.."
      - task: drmcp-unit
      - task: drmcp-integration
      - task: drmcp-acceptance

  drmcp-unit:
    desc: "Run DR MCP Library unit tests"
    cmds:
      - rm -rf .coverage .coverage.xml htmlcov
      - echo "Running DR MCP Library unit tests"
      - uv run pytest {{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}tests/drmcp/unit/{{end}} --cov=datarobot_genai.drmcp --cov-report=xml --cov-report=html --cov-report=term-missing -s -vv
    silent: true

  drmcp-integration:
    desc: "Run DR MCP Library integration tests"
    cmds:
      - echo "Running DR MCP Library integration tests"
      - uv run pytest {{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}tests/drmcp/integration/{{end}} -s -vv
    silent: true

  drmcp-acceptance:
    desc: "Run DR MCP Library acceptance tests"
    vars:
      PORT: 8652
    cmds:
      - task: drmcp-test-otel-server-background
      - task: drmcp-test-dev-server-background
      - defer: |
          echo "Stopping DR MCP Library MCP Server"
          lsof -i :{{.PORT}} | grep LISTEN | awk '{print $2}' | xargs kill -9 2>/dev/null || true
          echo "Stopping Jaeger"
          docker stop jaeger || true
      - echo "Running DR MCP Library acceptance tests"
      - DR_MCP_SERVER_URL=http://localhost:{{.PORT}}/mcp uv run pytest {{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}tests/drmcp/acceptance/{{end}} -s -vv
    silent: true

  drmcp-test-interactive:
    desc: "ðŸ§ª Run interactive MCP client test"
    vars:
      PORT: 8652
    cmds:
      - defer: |
          echo "Stopping MCP Server"
          lsof -i :{{.PORT}} | grep LISTEN | awk '{print $2}' | xargs kill -9 2>/dev/null || true
          echo "Stopping Jaeger"
          docker stop jaeger || true
      - echo "ðŸ§ª Starting interactive MCP client test"
      - |
        if [ -z "$DR_MCP_SERVER_URL" ]; then
          echo "DR_MCP_SERVER_URL is not set, setting it to http://localhost:{{.PORT}}/mcp/"
          export DR_MCP_SERVER_URL=http://localhost:{{.PORT}}/mcp/
        fi
        if [ "$DR_MCP_SERVER_URL" = "http://localhost:{{.PORT}}/mcp/" ]; then
          echo "DR_MCP_SERVER_URL is set to default, starting server in background"
          task drmcp-test-otel-server-background || true
          task drmcp-test-dev-server-background
        fi
        echo ""
        uv run python -m datarobot_genai.drmcp.test_utils.test_interactive
    silent: false

