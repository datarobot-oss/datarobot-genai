version: '3'

tasks:
  test:
    desc: "Run repo unit tests via pytest"
    cmds:
      - mkdir -p test_results
      - |
          set -e
          PYTHON_MINOR_VERSION=$(uv run python -c 'import sys; print(sys.version_info.minor)')
          if [ "$PYTHON_MINOR_VERSION" = "10" ]; then
            NAT_IGNORED_TESTS=tests/nat
            COV_FAIL_UNDER=75
          else
            NAT_IGNORED_TESTS=tests/nat/integration
            COV_FAIL_UNDER=80
          fi
          uv run pytest --junitxml=test_results/test-results.xml \
            --cov=datarobot_genai --cov-branch --cov-fail-under=${COV_FAIL_UNDER} --no-cov-on-fail \
            -vv -s tests \
            --ignore=tests/drmcp/integration --ignore=tests/drmcp/acceptance --ignore=${NAT_IGNORED_TESTS}
    silent: true

  test-module:
    desc: "Run repo unit tests via pytest for a specific module"
    cmds:
      - mkdir -p test_results
      - |
          set -e
          if [ -z "${MODULE}" ]; then
            echo "MODULE is required (e.g., MODULE=langgraph)"
            exit 2
          fi
          echo "pytest path: tests/${MODULE}"
          PYTHON_MINOR_VERSION=$(uv run python -c 'import sys; print(sys.version_info.minor)')
          if [ "$PYTHON_MINOR_VERSION" = "10" ]; then
            NAT_IGNORED_TESTS=tests/nat
          else
            NAT_IGNORED_TESTS=tests/nat/integration
          fi
          uv run pytest tests/${MODULE} \
            --junitxml=test_results/test-results.xml -vv -s \
            --ignore=tests/drmcp/integration --ignore=tests/drmcp/acceptance --ignore=${NAT_IGNORED_TESTS}
    silent: true

  smoke-extras-none:
    desc: "ðŸ§ª Test with no dependency groups"
    cmds:
      - echo "ðŸ§ª Testing with no dependency groups (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - python -m venv .venv-ci-test
      - source .venv-ci-test/bin/activate && python -m pip install -U pip wheel setuptools
      - source .venv-ci-test/bin/activate && pip install .
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "none"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-crewai:
    desc: "ðŸ§ª Test with crewai dependency group"
    cmds:
      - echo "ðŸ§ª Testing with crewai dependency group (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - VIRTUAL_ENV=.venv-ci-test uv sync --group crewai --no-dev
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "crewai"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-langgraph:
    desc: "ðŸ§ª Test with langgraph dependency group"
    cmds:
      - echo "ðŸ§ª Testing with langgraph dependency group (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - VIRTUAL_ENV=.venv-ci-test uv sync --group langgraph --no-dev
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "langgraph"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-llamaindex:
    desc: "ðŸ§ª Test with llamaindex dependency group"
    cmds:
      - echo "ðŸ§ª Testing with llamaindex dependency group (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - VIRTUAL_ENV=.venv-ci-test uv sync --group llamaindex --no-dev
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "llamaindex"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-drmcp:
    desc: "ðŸ§ª Test with drmcp dependency group"
    cmds:
      - echo "ðŸ§ª Testing with drmcp dependency group (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - VIRTUAL_ENV=.venv-ci-test uv sync --group drmcp --no-dev
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "drmcp"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-all:
    desc: "ðŸ§ª Test with all dependency groups"
    cmds:
      - echo "ðŸ§ª Testing with all dependency groups (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - VIRTUAL_ENV=.venv-ci-test uv sync --group crewai --group langgraph --group llamaindex --group drmcp --no-dev
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "all"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-matrix:
    desc: "ðŸ§ª Test all dependency group combinations (like CI matrix)"
    cmds:
      - echo "ðŸ§ª Testing all dependency group combinations..."
      - task: smoke-extras-none
      - task: smoke-extras-crewai
      - task: smoke-extras-langgraph
      - task: smoke-extras-llamaindex
      - task: smoke-extras-drmcp
      - task: smoke-extras-all
    silent: true
