version: '3'

env:
  PYTHONWARNINGS: "ignore::UserWarning,ignore::RuntimeWarning"

tasks:
  test:
    desc: "Run repo unit tests via pytest"
    cmds:
      - mkdir -p test_results
      - |
          set -e
          COV_FAIL_UNDER=80
          uv run pytest --junitxml=test_results/test-results.xml \
            --cov=datarobot_genai --cov-branch --cov-fail-under=${COV_FAIL_UNDER} --no-cov-on-fail \
            -vv -s tests \
            --ignore=tests/drmcp/integration --ignore=tests/drmcp/acceptance --ignore=tests/nat/integration
    silent: true

  # Use when crewai extra is not installed (e.g. macOS Intel: install-no-crewai).
  test-no-crewai:
    desc: "Run unit tests excluding crewai (when crewai extra not installed)"
    cmds:
      - mkdir -p test_results
      - |
          uv run pytest --junitxml=test_results/test-results.xml \
            --cov=datarobot_genai --cov-branch --no-cov-on-fail \
            -vv -s tests \
            --ignore=tests/drmcp/integration --ignore=tests/drmcp/acceptance --ignore=tests/nat/integration \
            --ignore=tests/crewai
    silent: true

  test-module:
    desc: "Run repo unit tests via pytest for a specific module"
    requires:
      vars:
        - name: MODULE
          enum:
            - core
            - crewai
            - langgraph
            - llamaindex
            - drmcp
            - nat
            - dragent
    cmds:
      - mkdir -p test_results
      - |
          echo "pytest path: tests/{{.MODULE}}"
          uv run pytest tests/{{.MODULE}} \
            --junitxml=test_results/test-results.xml -vv -s \
            --ignore=tests/drmcp/integration --ignore=tests/drmcp/acceptance --ignore=tests/nat/integration
    silent: true

  smoke-extras-none:
    desc: "ðŸ§ª Test with no extras"
    cmds:
      - echo "ðŸ§ª Testing with no extras (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - python -m venv .venv-ci-test
      - source .venv-ci-test/bin/activate && python -m pip install -U pip wheel setuptools
      - source .venv-ci-test/bin/activate && pip install .
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "none"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-crewai:
    desc: "ðŸ§ª Test with crewai extra"
    cmds:
      - echo "ðŸ§ª Testing with crewai extra (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - python -m venv .venv-ci-test
      - source .venv-ci-test/bin/activate && python -m pip install -U pip wheel setuptools
      - source .venv-ci-test/bin/activate && pip install ".[crewai]"
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "crewai"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-langgraph:
    desc: "ðŸ§ª Test with langgraph extra"
    cmds:
      - echo "ðŸ§ª Testing with langgraph extra (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - python -m venv .venv-ci-test
      - source .venv-ci-test/bin/activate && python -m pip install -U pip wheel setuptools
      - source .venv-ci-test/bin/activate && pip install ".[langgraph]"
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "langgraph"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-llamaindex:
    desc: "ðŸ§ª Test with llamaindex extra"
    cmds:
      - echo "ðŸ§ª Testing with llamaindex extra (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - python -m venv .venv-ci-test
      - source .venv-ci-test/bin/activate && python -m pip install -U pip wheel setuptools
      - source .venv-ci-test/bin/activate && pip install ".[llamaindex]"
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "llamaindex"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-drmcp:
    desc: "ðŸ§ª Test with drmcp extra"
    cmds:
      - echo "ðŸ§ª Testing with drmcp extra (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - python -m venv .venv-ci-test
      - source .venv-ci-test/bin/activate && python -m pip install -U pip wheel setuptools
      - source .venv-ci-test/bin/activate && pip install ".[drmcp]"
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "drmcp"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-all:
    desc: "ðŸ§ª Test with all extras"
    cmds:
      - echo "ðŸ§ª Testing with all extras (fresh venv like CI)..."
      - rm -rf .venv-ci-test
      - python -m venv .venv-ci-test
      - source .venv-ci-test/bin/activate && python -m pip install -U pip wheel setuptools
      - source .venv-ci-test/bin/activate && pip install ".[crewai,langgraph,llamaindex,drmcp]"
      - source .venv-ci-test/bin/activate && python scripts/smoke_optional_extras.py --extras "all"
      - rm -rf .venv-ci-test
    silent: true

  smoke-extras-matrix:
    desc: "ðŸ§ª Test all optional extras combinations (like CI matrix)"
    cmds:
      - echo "ðŸ§ª Testing all extras combinations..."
      - task: smoke-extras-none
      - task: smoke-extras-crewai
      - task: smoke-extras-langgraph
      - task: smoke-extras-llamaindex
      - task: smoke-extras-drmcp
      - task: smoke-extras-all
    silent: true
